/*! GizarteSegurantzaGrunt 27-05-2013 */
"use strict";var App=function(a,b,c){function d(a){return a.toString().replace(/\B(?=(\d{3})+(?!\d))/g,".")}c.highlight="undefined"==typeof c.highlight?!0:c.highlight,c.chart="undefined"==typeof c.chart?!0:c.chart,c.table="undefined"==typeof c.table?!0:c.table,c.selector="undefined"==typeof c.selector?!0:c.selector;var e,f,g,h,i,j=this;h={title:"Gizarte Segurantzan afiliazioa Aiaraldean",isStacked:!0,width:c.width||380,chartArea:{width:c.width-45||335,left:45,top:20,height:300},animation:{duration:600,easing:"linear"},legend:{position:"in"},vAxis:{textStyle:{fontSize:12}},hAxis:{textStyle:{fontSize:12}}},i=RecordedEmployment.init(a);var k=function(a){if("undefined"!=typeof e){var b=google.visualization.arrayToDataTable(a.getDetailed());e.draw(b,h)}},l=function(a){if("undefined"!=typeof f){var b=google.visualization.arrayToDataTable(a.getTable());f.draw(b,h)}},m=function(a){if("undefined"!=typeof g){var b=a.getHighLights();g.find(".total").text(d(b.current)),g.find(".compare-month span").text(b.sincePreviousMonth).removeClass("positive negative").addClass(b.sincePreviousMonthSign),g.find(".compare-year span").text(b.sincePreviousYear).removeClass("positive negative").addClass(b.sincePreviousYearSign),g.find(".month").text(b.month)}},n=function(){q(),p(),o(),r(),j.refresh()},o=function(){if(c.table){var a=$("<div/>",{"class":"chart_table",style:"height: 210px;width:"+c.width+"px;"}).appendTo(b);f=new google.visualization.Table(a[0])}},p=function(){if(c.chart){var a=$("<div/>",{"class":"chart_div",style:"height: 360px;width:"+c.width+"px;"}).appendTo(b);e=new google.visualization.AreaChart(a[0])}},q=function(){if(c.highlight){var a=$("<div/>",{"class":"chart_hl"}).appendTo(b);a.append("<h2>Langileak guztira</h2>"),a.append('<div class="month">0000/00</div>'),a.append('<div class="total">0</div>'),a.append('<div class="compare compare-month"><span class="negative">0</span> aurreko hilabetetik</div>'),a.append('<div class="compare compare-year"><span class="negative">0</span> aurreko urtetik</div>'),g=a}},r=function(){if(i.municipalities.length>1&&c.selector){var a=$("<div/>",{"class":"chart_selector",style:"width:"+c.width+"px;margin-top: 10px;text-align: center;"}).appendTo(b);jQuery.each(i.municipalities,function(b,c){a.append("<div class='mselector selected'>"+c.name+"</div> ")}),$("div.mselector").on("click",function(){if(1!==$(".chart_selector > .selected").length||!$(this).hasClass("selected")){$(this).toggleClass("selected");var a=$(this).text();i.selectedMunicipalities[a]=!i.selectedMunicipalities[a],j.refresh()}})}};j.refresh=function(){var a=i.sum(i);k(a),l(a),m(a)},$(document).ready(function(){google.load("visualization","1",{packages:["corechart","table"],callback:n})})},CouncilLoader=function(){var a,b=this,c=$.getUrlVar("councilCodes");a="undefined"!=typeof c?JSON.parse(c):["01001","01002"];var d="http://mongodb-rest.herokuapp.com/opendata/IneCouncils?limit=20&query=",e={ineCode:{$in:a}};b.load=function(){return $.getJSON(d+JSON.stringify(e),function(){})}},RecordedEmployment=new function(){var a=this;a.municipalities=[],a.selectedMunicipalities={},a.findOrCreateMunicipality=function(a,c){for(var d=a,e=d.municipalities.length,f=0;e>f;f++)if(d.municipalities[f].name===c)return d.municipalities[f];var g=new b(c);return d.municipalities.push(g),d.selectedMunicipalities[g.name]=!0,g},a.sum=function(a){var b,c=a,f=this,g=0,h=null,i=0,j=new d;b=c.municipalities,g=b.length;for(var k=0;g>k;k++)if(h=f.municipalities[k],c.selectedMunicipalities[h.name]!==!1){i=h.periods.length;for(var l=0;i>l;l++){void 0===j.months[h.periods[l].time]&&(j.months[h.periods[l].time]=new e);var m=j.months[h.periods[l].time];m.general+=parseInt(h.periods[l].data.general,10),m.farming+=parseInt(h.periods[l].data.farming,10),m.sea+=parseInt(h.periods[l].data.sea,10),m.coal+=parseInt(h.periods[l].data.coal,10),m.house+=parseInt(h.periods[l].data.house,10),m.freelance+=parseInt(h.periods[l].data.freelance,10),m.total+=parseInt(h.periods[l].data.total,10)}}return j};var b=function(a){var b=this;b.name=a,b.periods=[]},c=function(a){var b=this;b.time=a},d=function(){var a=this;a.months=[],a.getHighLights=function(){var b=Object.keys(a.months),c=b.length,d={};b.sort();var e=a.months[b[c-1]].total,f=a.months[b[c-2]].total,g=a.months[b[c-13]].total;return d.current=e,d.sincePreviousMonth=Math.abs(e-f),d.sincePreviousMonthSign=e-f>0?"positive":"negative",d.sincePreviousYear=Math.abs(e-g),d.sincePreviousYearSign=e-g>0?"positive":"negative",d.month=b[c-1],d},a.getDetailed=function(){var b,c,d=[],e=[],f=[],g=[],h=0,i=0,j=0,k=0,l=0,m=Object.keys(a.months),n=m.length;for(m.sort(),c=0;n>c;c++)b=m[c],e=[],e.push(b),e.push(a.months[b].general),e.push(a.months[b].farming),h+=a.months[b].farming,e.push(a.months[b].sea),j+=a.months[b].sea,e.push(a.months[b].coal),k+=a.months[b].coal,e.push(a.months[b].house),i+=a.months[b].house,e.push(a.months[b].freelance),l+=a.months[b].freelance,d.push(e);for(g=[],g.push("Hilabetea"),g.push("Orokorra"),h>0&&g.push("Nekazaritza"),j>0&&g.push("Itsasoa"),k>0&&g.push("Ikatza"),i>0&&g.push("Etxeko langileak"),l>0&&g.push("Autonomoak"),f.push(g),c=0;n>c;c++)g=[],g.push(d[c][0]),g.push(d[c][1]),h>0&&g.push(d[c][2]),j>0&&g.push(d[c][3]),k>0&&g.push(d[c][4]),i>0&&g.push(d[c][5]),l>0&&g.push(d[c][6]),f.push(g);return f},a.getTable=function(){var c=[];c[0]=[],c[0].push("Hilabetea"),c[1]=[],c[1].push("Orokorra"),c[2]=[],c[2].push("Nekazaritza"),c[3]=[],c[3].push("Itsasoa"),c[4]=[],c[4].push("Ikatza"),c[5]=[],c[5].push("Etxeko langileak"),c[6]=[],c[6].push("Autonomoak"),c[7]=[],c[7].push("Guztira");var d,e,f=Object.keys(a.months),g=f.length;for(f.sort(),e=0;g>e;e++)d=f[e],c[0].push(d),c[1].push(b(a.months[d].general)),c[2].push(b(a.months[d].farming)),c[3].push(b(a.months[d].sea)),c[4].push(b(a.months[d].coal)),c[5].push(b(a.months[d].house)),c[6].push(b(a.months[d].freelance)),c[7].push(b(a.months[d].total));return c};var b=function(a){return 1===a?"<5":""+a};a.getTotal=function(){var b=[],c=[];c.push("Guztira"),b.push(c);var d,e,f=Object.keys(a.months),g=f.length;for(f.sort(),e=0;g>e;e++)d=f[e],c=[],c.push(d),c.push(a.months[d].total),b.push(c)}},e=function(){var a=this;a.general=0,a.farming=0,a.sea=0,a.coal=0,a.house=0,a.freelance=0,a.total=0};return a.init=function(b){var d;d={},d.data=b;for(var f,g=d.data.length,h=1;g>h;h++){f=d.data[h];var i=a.findOrCreateMunicipality(a,f[0]),j=new c(f[1]);j.data=new e,j.data.general=f[2],j.data.farming=f[3],j.data.house=f[4],j.data.sea=f[5],j.data.coal=f[6],j.data.freelance=f[7],j.data.total=f[8],i.periods.push(j)}return a},{init:a.init}},ServiceDataLoader=function(){var a=this;a.load=function(){var a=new CouncilLoader,b=new SSEmploymentLoader,c=[],d=new $.Deferred;return c.push(["Council","Month","general","farming","house","sea","coal","freelance","total"]),$.when(a.load(),b.load()).done(function(a,b){for(var e=a[0].length,f=b[0].length,g=0;f>g;g++){for(var h=b[0][g],i={},j=0;e>j;j++)if(a[0][j].ineCode===h.councilCode){i.council=a[0][j].name;break}i.month=h.yearMonth,i.general=h.general,i.farming=h.agrario,i.sea=h.mar,i.coal=h.carbon,i.house=h.hogar,i.freelance=h.autonomos,i.total=h.total,c.push([i.council,i.month,i.general,i.farming,i.house,i.sea,i.coal,i.freelance,i.total])}d.resolve(c)}),d.promise()}},SSEmploymentLoader=function(){var a,b=this,c=$.getUrlVar("councilCodes");a="undefined"!=typeof c?JSON.parse(c):["01001","01002"];var d="http://mongodb-rest.herokuapp.com/opendata/SSLastDayOfMonthByCouncil?query=",e={councilCode:{$in:a}};b.load=function(){return $.getJSON(d+JSON.stringify(e),function(){})}},StaticDataLoader=function(){var a=this;a.load=function(a){var b;return $.ajax({async:!1,global:!1,url:a,dataType:"json",success:function(a){b=a}}),b.data}};Object.keys=Object.keys||function(){var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],d=c.length;return function(e){if("object"!=typeof e&&"function"!=typeof e||null===e)throw new TypeError("Object.keys called on a non-object");var f=[];for(var g in e)a.call(e,g)&&f.push(g);if(b)for(var h=0;d>h;h++)a.call(e,c[h])&&f.push(c[h]);return f}}(),Array.prototype.addAll=function(){for(var a,b=0;b<arguments.length;b++){a=arguments[b];for(var c=0;c<a.length;c++)this.push(a[c])}},$.extend({getUrlVars:function(){for(var a,b=[],c=decodeURIComponent(window.location.href).slice(window.location.href.indexOf("?")+1).split("&"),d=0;d<c.length;d++)a=c[d].split("="),b.push(a[0]),b[a[0]]=a[1];return b},getUrlVar:function(a){return $.getUrlVars()[a]}});